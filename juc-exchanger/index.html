<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>JUC并发工具之Exchanger源码解析 | Java技术天地</title><meta name="description" content="JUC并发工具之Exchanger源码解析"><meta name="keywords" content="Java,并发,Exchanger"><meta name="author" content="Java技术天地"><meta name="copyright" content="Java技术天地"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon-32x32.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://hm.baidu.com"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="JUC并发工具之Exchanger源码解析"><meta name="twitter:description" content="JUC并发工具之Exchanger源码解析"><meta name="twitter:image" content="https://www.zzwzdx.cn/img/avatar.png"><meta property="og:type" content="article"><meta property="og:title" content="JUC并发工具之Exchanger源码解析"><meta property="og:url" content="https://www.zzwzdx.cn/juc-exchanger/"><meta property="og:site_name" content="Java技术天地"><meta property="og:description" content="JUC并发工具之Exchanger源码解析"><meta property="og:image" content="https://www.zzwzdx.cn/img/avatar.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode="1",t=Cookies.get("theme");if("1"==autoChangeMode){var isDarkMode=window.matchMedia("(prefers-color-scheme: dark)").matches,isLightMode=window.matchMedia("(prefers-color-scheme: light)").matches,isNotSpecified=window.matchMedia("(prefers-color-scheme: no-preference)").matches,hasNoSupport=!isDarkMode&&!isLightMode&&!isNotSpecified;if(void 0===t){if(isLightMode)activateLightMode();else if(isDarkMode)activateDarkMode();else if(isNotSpecified||hasNoSupport){console.log("You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.");var now=new Date,hour=now.getHours(),isNight=hour<6||18<=hour;isNight?activateDarkMode():activateLightMode()}}else"light"==t?activateLightMode():activateDarkMode()}else"2"==autoChangeMode?(isNight=(hour=(now=new Date).getHours())<6||18<=hour,void 0===t?isNight?activateDarkMode():activateLightMode():"light"===t?activateLightMode():activateDarkMode()):"dark"==t?activateDarkMode():"light"==t&&activateLightMode();function activateDarkMode(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#000")}function activateLightMode(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#fff")}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://www.zzwzdx.cn/juc-exchanger/"><link rel="prev" title="JUC并发容器之ConcurrentHashMap" href="https://www.zzwzdx.cn/juc-concurrenthashmap/"><link rel="next" title="JUC并发工具之Semaphore源码解析" href="https://www.zzwzdx.cn/juc-semaphore/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6cdf806ea3d36641644ddfae3f9e80cb";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容:${query}"}},translate:{defaultEncoding:2,translateDelay:0,cookieDomain:"https://www.zzwzdx.cn/",msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},bookmark:{message_prev:"按",message_next:"键将本页加入书签"},runtime_unit:"天",runtime:!0,copyright:{languages:{author:"作者: Java技术天地",link:"链接: ",source:"来源: Java技术天地",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},ClickShowText:void 0,medium_zoom:!1,fancybox:!0,Snackbar:{bookmark:{message_prev:"按",message_next:"键将本页加入书签"},chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#2d3035",position:"top-center"},baiduPush:!1,highlightCopy:!0,highlightLang:!0,highlightShrink:"false",isFontAwesomeV5:!1,isPhotoFigcaption:!1}</script><script>var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isSidebar:!1}</script><noscript><style>#page-header{opacity:1}.justified-gallery img{opacity:1}</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">65</div></a></div></div><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">27</div></a></div></div><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/" aria-current="page"><i class="fa-fw fa fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/juc/" aria-current="page"><i class="fa-fw fa fa-lock"></i> <span>Java并发</span></a></div><div class="menus_item"><a class="site-page" href="/spring-ioc/" aria-current="page"><i class="fa-fw fa fa-eercast"></i> <span>Spring IOC专题</span></a></div><div class="menus_item"><a class="site-page" href="/dp/" aria-current="page"><i class="fa-fw fa fa-ge"></i> <span>设计模式</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-meetup" aria-hidden="true"></i> <span>Mybatis教程</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/mybatis3/"><i class="fa-fw fa fa-anchor"></i> <span>Mybatis基础教程</span></a></li><li><a class="site-page" href="/mybatis3-source/"><i class="fa-fw fa fa-asterisk"></i> <span>Mybatis源码分析</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/" aria-current="page"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></div></div></div></div><div class="main-bg" id="body-wrap"><div class="post-bg" id="nav"><div id="page-header"><a class="pull_left" id="blog_name" href="/"><i class="logo"></i><span class="blog_title" id="site-name">Java技术天地</span></a><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/" aria-current="page"><i class="fa-fw fa fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/juc/" aria-current="page"><i class="fa-fw fa fa-lock"></i> <span>Java并发</span></a></div><div class="menus_item"><a class="site-page" href="/spring-ioc/" aria-current="page"><i class="fa-fw fa fa-eercast"></i> <span>Spring IOC专题</span></a></div><div class="menus_item"><a class="site-page" href="/dp/" aria-current="page"><i class="fa-fw fa fa-ge"></i> <span>设计模式</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-meetup" aria-hidden="true"></i> <span>Mybatis教程</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/mybatis3/"><i class="fa-fw fa fa-anchor"></i> <span>Mybatis基础教程</span></a></li><li><a class="site-page" href="/mybatis3-source/"><i class="fa-fw fa fa-asterisk"></i> <span>Mybatis源码分析</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/" aria-current="page"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></div></div><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i></a></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="post-info"><div id="post-title"><div class="posttitle">JUC并发工具之Exchanger源码解析</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date" title="发表于 2019-09-21 09:11:17"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-09-21</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" target="_blank">Java并发编程</a></span><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/juc-exchanger/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div><div id="article-container"><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>Exchanger(交换者)是用于线程协作的工具类。Exchanger用于进行两个线程之间的数据交换。它提供一个同步点，在这个同步点，两个线程可以交换彼此的数据。这两个线程通过exchange()方法交换数据，当一个线程先执行exchange()方法后，它会一直等待第二个线程也执行exchange()方法，当这两个线程到达同步点时，这两个线程就可以交换数据了。</p><p>Exchanger的算法核心是通过一个可以交换数据的slot和一个可以带有数据item的参与者，在源码中的定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (slot is empty) &#123; <span class="comment">// offer</span></span><br><span class="line">        <span class="comment">// slot为空时，将item 设置到Node 中        </span></span><br><span class="line">        place item in a Node;</span><br><span class="line">        <span class="keyword">if</span> (can CAS slot from empty to node) &#123;</span><br><span class="line">            <span class="comment">// 当将node通过CAS交换到slot中时，挂起线程等待被唤醒</span></span><br><span class="line">            wait <span class="keyword">for</span> release;</span><br><span class="line">            <span class="comment">// 被唤醒后返回node中匹配到的item</span></span><br><span class="line">            <span class="keyword">return</span> matching item in node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (can CAS slot from node to empty) &#123; <span class="comment">// release</span></span><br><span class="line">         <span class="comment">// 将slot设置为空</span></span><br><span class="line">        <span class="comment">// 获取node中的item，将需要交换的数据设置到匹配的item</span></span><br><span class="line">        get the item in node;</span><br><span class="line">        set matching item in node;</span><br><span class="line">        <span class="comment">// 唤醒等待的线程</span></span><br><span class="line">        release waiting thread;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// else retry on CAS failure</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>比如有2条线程A和B，A线程交换数据时，发现slot为空，则将需要交换的数据放在slot中等待其它线程进来交换数据，等线程B进来，读取A设置的数据，然后设置线程B需要交换的数据，然后唤醒A线程，原理就是这么简单。但是当多个线程之间进行交换数据时就会出现问题，所以Exchanger加入了slot数组。</p><p>Exchanger中定义了几个重要的成员变量,它们分别是：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Participant participant;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Node[] arena;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Node slot;</span><br></pre></td></tr></table></figure><p>participant的作用是为每个线程保留唯一的一个Node节点。slot为单个槽，arena为数组槽。他们都是Node类型。这里arena存在的意义是当有多个参与者使用同一个交换场所时，会存在严重伸缩性问题。既然单个交换场所存在问题，那么我们就安排多个，也就是数组arena。通过数组arena来安排不同的线程使用不同的slot来降低竞争问题，并且可以保证最终一定会成对交换数据。但是Exchanger不是一来就会生成arena数组来降低竞争，只有当产生竞争时才会生成arena数组。那么怎么将Node与当前线程绑定呢？这里就要用到Participant ，Participant 的作用就是为每个线程保留唯一的一个Node节点，它继承ThreadLocal，同时在Node节点中还记录了其在arena中的下标index的值。</p><p>Node的数据结构如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">     <span class="comment">// arena的下标，多个槽位的时候利用</span></span><br><span class="line">    <span class="keyword">int</span> index; </span><br><span class="line">    <span class="comment">// 上一次记录的Exchanger.bound</span></span><br><span class="line">    <span class="keyword">int</span> bound; </span><br><span class="line">    <span class="comment">// 在当前bound下CAS失败的次数；</span></span><br><span class="line">    <span class="keyword">int</span> collides;</span><br><span class="line">    <span class="comment">// 用于自旋；</span></span><br><span class="line">    <span class="keyword">int</span> hash; </span><br><span class="line">    <span class="comment">// 这个线程的当前项，也就是需要交换的数据；</span></span><br><span class="line">    Object item; </span><br><span class="line">    <span class="comment">//做releasing操作的线程传递的项；</span></span><br><span class="line">    <span class="keyword">volatile</span> Object match; </span><br><span class="line">    <span class="comment">//挂起时设置线程值，其他情况下为null；</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread parked;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Exchanger的核心方法为<code>exchange(V x)</code>，下面我们就来分析下<code>exchange(V x)</code>方法。</p><h3 id="exchange-V-x-方法"><a href="#exchange-V-x-方法" class="headerlink" title="exchange(V x)方法"></a>exchange(V x)方法</h3><p><strong>exchange(V x)</strong>：等待另一个线程到达此交换点（除非当前线程被中断），然后将给定的对象传送给该线程，并接收该线程的对象。方法定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">exchange</span><span class="params">(V x)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Object v;</span><br><span class="line">    <span class="comment">// 当参数为null时需要将item设置为空</span></span><br><span class="line">    Object item = (x == <span class="keyword">null</span>) ? NULL_ITEM : x; <span class="comment">// translate null args</span></span><br><span class="line">    <span class="comment">// 注意到这里的这个表达式是整个方法的核心</span></span><br><span class="line">    <span class="keyword">if</span> ((arena != <span class="keyword">null</span> ||</span><br><span class="line">            (v = slotExchange(item, <span class="keyword">false</span>, <span class="number">0</span> L)) == <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">        ((Thread.interrupted() || <span class="comment">// disambiguates null return</span></span><br><span class="line">            (v = arenaExchange(item, <span class="keyword">false</span>, <span class="number">0</span> L)) == <span class="keyword">null</span>)))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="keyword">return</span> (v == NULL_ITEM) ? <span class="keyword">null</span> : (V) v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>仔细分析上述方法中的if语句，可以得知：</p><ul><li>只有当arena 为空时，才执行slotExchange(item, false, 0 L)方法。</li><li>当arena不为空时，或者(arena为null且slotExchange方法返回null)时，此时线程未中断，才会执行arenaExchange方法;</li><li>线程中断时，就直接抛出线程中断异常。</li></ul><p>下面我们再看看slotExchange方法，其定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> Object <span class="title">slotExchange</span><span class="params">(Object item, <span class="keyword">boolean</span> timed, <span class="keyword">long</span> ns)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前线程node对象</span></span><br><span class="line">    Node p = participant.get();</span><br><span class="line">    <span class="comment">// 当前线程</span></span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    <span class="comment">// 如果线程被中断，就直接返回null</span></span><br><span class="line">    <span class="keyword">if</span> (t.isInterrupted()) <span class="comment">// preserve interrupt status so caller can recheck</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 自旋</span></span><br><span class="line">    <span class="keyword">for</span> (Node q;;) &#123;</span><br><span class="line">        <span class="comment">// 将slot值赋给q</span></span><br><span class="line">        <span class="keyword">if</span> ((q = slot) != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="comment">// slot 不为null，即表示已有线程已经把需要交换的数据设置在slot中了</span></span><br><span class="line">			<span class="comment">// 通过CAS将slot设置成null</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, SLOT, q, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="comment">// CAS操作成功后，将slot中的item赋值给对象v，以便返回。</span></span><br><span class="line">                <span class="comment">// 这里也是就读取之前线程要交换的数据</span></span><br><span class="line">                Object v = q.item;</span><br><span class="line">                <span class="comment">// 将当前线程需要交给的数据设置在q中的match</span></span><br><span class="line">                q.match = item;</span><br><span class="line">                 <span class="comment">// 获取被挂起的线程</span></span><br><span class="line">                Thread w = q.parked;</span><br><span class="line">                <span class="keyword">if</span> (w != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">// 如果线程不为null，唤醒它</span></span><br><span class="line">                    U.unpark(w);</span><br><span class="line">                <span class="comment">// 返回其他线程给的V</span></span><br><span class="line">                <span class="keyword">return</span> v;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// create arena on contention, but continue until slot null</span></span><br><span class="line">            <span class="comment">// CAS 操作失败，表示有其它线程竞争，在此线程之前将数据已取走</span></span><br><span class="line">            <span class="comment">// NCPU:CPU的核数</span></span><br><span class="line">            <span class="comment">// bound == 0 表示arena数组未初始化过，CAS操作bound将其增加SEQ</span></span><br><span class="line">            <span class="keyword">if</span> (NCPU &gt; <span class="number">1</span> &amp;&amp; bound == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                U.compareAndSwapInt(<span class="keyword">this</span>, BOUND, <span class="number">0</span>, SEQ))</span><br><span class="line">                <span class="comment">// 初始化arena数组</span></span><br><span class="line">                arena = <span class="keyword">new</span> Node[(FULL + <span class="number">2</span>) &lt;&lt; ASHIFT];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 上面分析过，只有当arena不为空才会执行slotExchange方法</span></span><br><span class="line">		<span class="comment">// 所以表示刚好已有其它线程加入进来将arena初始化</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (arena != <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">// 这里就需要去执行arenaExchange</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// caller must reroute to arenaExchange</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 这里表示当前线程是以第一个线程进来交换数据</span></span><br><span class="line">            <span class="comment">// 或者表示之前的数据交换已进行完毕，这里可以看作是第一个线程</span></span><br><span class="line">            <span class="comment">// 将需要交换的数据先存放在当前线程变量p中</span></span><br><span class="line">            p.item = item;</span><br><span class="line">            <span class="comment">// 将需要交换的数据通过CAS设置到交换区slot</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, SLOT, <span class="keyword">null</span>, p))</span><br><span class="line">                <span class="comment">// 交换成功后跳出自旋</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// CAS操作失败，表示有其它线程刚好先于当前线程将数据设置到交换区slot</span></span><br><span class="line">            <span class="comment">// 将当前线程变量中的item设置为null，然后自旋获取其它线程存放在交换区slot的数据</span></span><br><span class="line">            p.item = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// await release</span></span><br><span class="line">    <span class="comment">// 执行到这里表示当前线程已将需要的交换的数据放置于交换区slot中了，</span></span><br><span class="line">    <span class="comment">// 等待其它线程交换数据然后唤醒当前线程</span></span><br><span class="line">    <span class="keyword">int</span> h = p.hash;</span><br><span class="line">    <span class="keyword">long</span> end = timed ? System.nanoTime() + ns : <span class="number">0</span> L;</span><br><span class="line">    <span class="comment">// 自旋次数</span></span><br><span class="line">    <span class="keyword">int</span> spins = (NCPU &gt; <span class="number">1</span>) ? SPINS : <span class="number">1</span>;</span><br><span class="line">    Object v;</span><br><span class="line">    <span class="comment">// 自旋等待直到p.match不为null，也就是说等待其它线程将需要交换的数据放置于交换区slot</span></span><br><span class="line">    <span class="keyword">while</span> ((v = p.match) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 下面的逻辑主要是自旋等待，直到spins递减到0为止</span></span><br><span class="line">        <span class="keyword">if</span> (spins &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            h ^= h &lt;&lt; <span class="number">1</span>;</span><br><span class="line">            h ^= h &gt;&gt;&gt; <span class="number">3</span>;</span><br><span class="line">            h ^= h &lt;&lt; <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">if</span> (h == <span class="number">0</span>)</span><br><span class="line">                h = SPINS | (<span class="keyword">int</span>) t.getId();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (h &lt; <span class="number">0</span> &amp;&amp; (--spins &amp; ((SPINS &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>)) == <span class="number">0</span>)</span><br><span class="line">                Thread.yield();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (slot != p)</span><br><span class="line">            spins = SPINS;</span><br><span class="line">        <span class="comment">// 此处表示未设置超时或者时间未超时</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; arena == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            (!timed || (ns = end - System.nanoTime()) &gt; <span class="number">0</span> L)) &#123;</span><br><span class="line">            <span class="comment">// 设置线程t被当前对象阻塞</span></span><br><span class="line">            U.putObject(t, BLOCKER, <span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">// 给p挂机线程的值赋值</span></span><br><span class="line">            p.parked = t;</span><br><span class="line">            <span class="keyword">if</span> (slot == p)</span><br><span class="line">                <span class="comment">// 如果slot还没有被置为null，也就表示暂未有线程过来交换数据，需要将当前线程挂起</span></span><br><span class="line">                U.park(<span class="keyword">false</span>, ns);</span><br><span class="line">            <span class="comment">// 线程被唤醒，将被挂起的线程设置为null</span></span><br><span class="line">            p.parked = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 设置线程t未被任何对象阻塞</span></span><br><span class="line">            U.putObject(t, BLOCKER, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 不是以上条件时（可能是arena已不为null或者超时）    </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, SLOT, p, <span class="keyword">null</span>)) &#123;</span><br><span class="line">             <span class="comment">// arena不为null则v为null,其它为超时则v为超市对象TIMED_OUT，并且跳出循环</span></span><br><span class="line">            v = timed &amp;&amp; ns &lt;= <span class="number">0</span> L &amp;&amp; !t.isInterrupted() ? TIMED_OUT : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 取走match值，并将p中的match置为null</span></span><br><span class="line">    U.putOrderedObject(p, MATCH, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 设置item为null</span></span><br><span class="line">    p.item = <span class="keyword">null</span>;</span><br><span class="line">    p.hash = h;</span><br><span class="line">    <span class="comment">// 返回交换值</span></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再来看arenaExchange方法，此方法被执行时表示多个线程进入交换区交换数据，arena数组已被初始化，此方法中的一些处理方式和slotExchange比较类似，它是通过遍历arena数组找到需要交换的数据。arenaExchange方法源码定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timed 为true表示设置了超时时间，ns为&gt;0的值，反之没有设置超时时间</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> Object <span class="title">arenaExchange</span><span class="params">(Object item, <span class="keyword">boolean</span> timed, <span class="keyword">long</span> ns)</span> </span>&#123;</span><br><span class="line">    Node[] a = arena;</span><br><span class="line">    <span class="comment">// 获取当前线程中的存放的node</span></span><br><span class="line">    Node p = participant.get();</span><br><span class="line">    <span class="comment">//index初始值0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = p.index;;) &#123; <span class="comment">// access slot at i</span></span><br><span class="line">        <span class="comment">// 遍历，如果在数组中找到数据则直接交换并唤醒线程，如未找到则将需要交换给其它线程的数据放置于数组中</span></span><br><span class="line">        <span class="keyword">int</span> b, m, c;</span><br><span class="line">        <span class="keyword">long</span> j; <span class="comment">// j is raw array offset</span></span><br><span class="line">        <span class="comment">// 其实这里就是向右遍历数组，只是用到了元素在内存偏移的偏移量</span></span><br><span class="line">        <span class="comment">// q实际为arena数组偏移(i + 1) *  128个地址位上的node</span></span><br><span class="line">        Node q = (Node) U.getObjectVolatile(a, j = (i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">        <span class="comment">// 如果q不为null，并且CAS操作成功，将下标j的元素置为null</span></span><br><span class="line">        <span class="keyword">if</span> (q != <span class="keyword">null</span> &amp;&amp; U.compareAndSwapObject(a, j, q, <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">// 表示当前线程已发现有交换的数据，然后获取数据，唤醒等待的线程</span></span><br><span class="line">            Object v = q.item; <span class="comment">// release</span></span><br><span class="line">            q.match = item;</span><br><span class="line">            Thread w = q.parked;</span><br><span class="line">            <span class="keyword">if</span> (w != <span class="keyword">null</span>)</span><br><span class="line">                U.unpark(w);</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        <span class="comment">// q 为null 并且 i 未超过数组边界    </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i &lt;= (m = (b = bound) &amp; MMASK) &amp;&amp; q == <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="comment">// 将需要给其它线程的item赋予给p中的item</span></span><br><span class="line">            p.item = item; <span class="comment">// offer</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapObject(a, j, <span class="keyword">null</span>, p)) &#123;</span><br><span class="line">                <span class="comment">// 交换成功</span></span><br><span class="line">                <span class="keyword">long</span> end = (timed &amp;&amp; m == <span class="number">0</span>) ? System.nanoTime() + ns : <span class="number">0</span> L;</span><br><span class="line">                Thread t = Thread.currentThread(); <span class="comment">// wait</span></span><br><span class="line">                <span class="comment">// 自旋直到有其它线程进入，遍历到该元素并与其交换，同时当前线程被唤醒</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> h = p.hash, spins = SPINS;;) &#123;</span><br><span class="line">                    Object v = p.match;</span><br><span class="line">                    <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 其它线程设置的需要交换的数据match不为null</span></span><br><span class="line">                        <span class="comment">// 将match设置null,item设置为null</span></span><br><span class="line">                        U.putOrderedObject(p, MATCH, <span class="keyword">null</span>);</span><br><span class="line">                        p.item = <span class="keyword">null</span>; <span class="comment">// clear for next use</span></span><br><span class="line">                        p.hash = h;</span><br><span class="line">                        <span class="keyword">return</span> v;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (spins &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        h ^= h &lt;&lt; <span class="number">1</span>;</span><br><span class="line">                        h ^= h &gt;&gt;&gt; <span class="number">3</span>;</span><br><span class="line">                        h ^= h &lt;&lt; <span class="number">10</span>; <span class="comment">// xorshift</span></span><br><span class="line">                        <span class="keyword">if</span> (h == <span class="number">0</span>) <span class="comment">// initialize hash</span></span><br><span class="line">                            h = SPINS | (<span class="keyword">int</span>) t.getId();</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (h &lt; <span class="number">0</span> &amp;&amp; <span class="comment">// approx 50% true</span></span><br><span class="line">                            (--spins &amp; ((SPINS &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>)) == <span class="number">0</span>)</span><br><span class="line">                            Thread.yield(); <span class="comment">// two yields per wait</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (U.getObjectVolatile(a, j) != p)</span><br><span class="line">                        <span class="comment">// 和slotExchange方法中的类似，arena数组中的数据已被CAS设置</span></span><br><span class="line">                       <span class="comment">// match值还未设置，让其再自旋等待match被设置</span></span><br><span class="line">                        spins = SPINS; <span class="comment">// releaser hasn't set match yet</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; m == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        (!timed ||</span><br><span class="line">                            (ns = end - System.nanoTime()) &gt; <span class="number">0</span> L)) &#123;</span><br><span class="line">                        <span class="comment">// 设置线程t被当前对象阻塞</span></span><br><span class="line">                        U.putObject(t, BLOCKER, <span class="keyword">this</span>); <span class="comment">// emulate LockSupport</span></span><br><span class="line">                         <span class="comment">// 线程t赋值</span></span><br><span class="line">                        p.parked = t; <span class="comment">// minimize window</span></span><br><span class="line">                        <span class="keyword">if</span> (U.getObjectVolatile(a, j) == p)</span><br><span class="line">                            <span class="comment">// 数组中对象还相等，表示线程还未被唤醒，唤醒线程</span></span><br><span class="line">                            U.park(<span class="keyword">false</span>, ns);</span><br><span class="line">                        p.parked = <span class="keyword">null</span>;</span><br><span class="line">                         <span class="comment">// 设置线程t未被任何对象阻塞</span></span><br><span class="line">                        U.putObject(t, BLOCKER, <span class="keyword">null</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (U.getObjectVolatile(a, j) == p &amp;&amp;</span><br><span class="line">                        U.compareAndSwapObject(a, j, p, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                        <span class="comment">// 这里给bound增加加一个SEQ</span></span><br><span class="line">                        <span class="keyword">if</span> (m != <span class="number">0</span>) <span class="comment">// try to shrink</span></span><br><span class="line">                            U.compareAndSwapInt(<span class="keyword">this</span>, BOUND, b, b + SEQ - <span class="number">1</span>);</span><br><span class="line">                        p.item = <span class="keyword">null</span>;</span><br><span class="line">                        p.hash = h;</span><br><span class="line">                        i = p.index &gt;&gt;&gt;= <span class="number">1</span>; <span class="comment">// descend</span></span><br><span class="line">                        <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">if</span> (timed &amp;&amp; m == <span class="number">0</span> &amp;&amp; ns &lt;= <span class="number">0</span> L)</span><br><span class="line">                            <span class="keyword">return</span> TIMED_OUT;</span><br><span class="line">                        <span class="keyword">break</span>; <span class="comment">// expired; restart</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// 交换失败，表示有其它线程更改了arena数组中下标i的元素</span></span><br><span class="line">                p.item = <span class="keyword">null</span>; <span class="comment">// clear offer</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 此时表示下标不在bound &amp; MMASK或q不为null但CAS操作失败</span></span><br><span class="line">           <span class="comment">// 需要更新bound变化后的值</span></span><br><span class="line">            <span class="keyword">if</span> (p.bound != b) &#123; <span class="comment">// stale; reset</span></span><br><span class="line">                p.bound = b;</span><br><span class="line">                p.collides = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 反向遍历</span></span><br><span class="line">                i = (i != m || m == <span class="number">0</span>) ? m : m - <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((c = p.collides) &lt; m || m == FULL ||</span><br><span class="line">                !U.compareAndSwapInt(<span class="keyword">this</span>, BOUND, b, b + SEQ + <span class="number">1</span>)) &#123;</span><br><span class="line">                 <span class="comment">// 记录CAS失败的次数</span></span><br><span class="line">                p.collides = c + <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 循环遍历</span></span><br><span class="line">                i = (i == <span class="number">0</span>) ? m : i - <span class="number">1</span>; <span class="comment">// cyclically traverse</span></span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// 此时表示bound值增加了SEQ+1</span></span><br><span class="line">                i = m + <span class="number">1</span>; <span class="comment">// grow</span></span><br><span class="line">            <span class="comment">// 设置下标</span></span><br><span class="line">            p.index = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看完上面<code>slotExchange</code>方法和<code>arenaExchange</code>方法定义，我们可以看出Exchanger工具类的实现还是很复杂的，虽然Exchanger的使用比较简单。</p></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noopener noreferrer" target="_blank">Java技术天地</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://www.zzwzdx.cn/juc-exchanger/">https://www.zzwzdx.cn/juc-exchanger/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="external nofollow noopener noreferrer">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.zzwzdx.cn" target="_blank">Java技术天地</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/" target="_blank">Java</a><a class="post-meta__tags" href="/tags/%E5%B9%B6%E5%8F%91/" target="_blank">并发</a><a class="post-meta__tags" href="/tags/Exchanger/" target="_blank">Exchanger</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/pay-wechat.png" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/pay-alipay.png" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/juc-concurrenthashmap/"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JUC并发容器之ConcurrentHashMap</div></div></a></div><div class="next-post pull_right"><a href="/juc-semaphore/"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JUC并发工具之Semaphore源码解析</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i> <span>相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/how-aqs-works/" title="AQS之工作原理"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-08-27</div><div class="relatedPosts_title">AQS之工作原理</div></div></a></div><div class="relatedPosts_item"><a href="/juc-cyclicbarrier/" title="JUC并发工具之CyclicBarrier源码解析"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-09-18</div><div class="relatedPosts_title">JUC并发工具之CyclicBarrier源码解析</div></div></a></div><div class="relatedPosts_item"><a href="/juc-semaphore/" title="JUC并发工具之Semaphore源码解析"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-09-20</div><div class="relatedPosts_title">JUC并发工具之Semaphore源码解析</div></div></a></div><div class="relatedPosts_item"><a href="/juc-concurrenthashmap/" title="JUC并发容器之ConcurrentHashMap"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-09-22</div><div class="relatedPosts_title">JUC并发容器之ConcurrentHashMap</div></div></a></div><div class="relatedPosts_item"><a href="/juc-redblacktree/" title="JUC并发容器之ConcurrentHashMap之红黑树源码分析"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-09-25</div><div class="relatedPosts_title">JUC并发容器之ConcurrentHashMap之红黑树源码分析</div></div></a></div><div class="relatedPosts_item"><a href="/java-thread/" title="Java线程概念理解"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-05-09</div><div class="relatedPosts_title">Java线程概念理解</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="gitalk-container"></div><script>var gitalk=new Gitalk({clientID:"7cba1dad1cf41bf40ba9",clientSecret:"5d208277d004b840b5b67a31ebbf6aeb80a7a901",repo:"gitalk",owner:"zhangzwd",admin:["zhangzwd"],id:md5(decodeURI(location.pathname)),language:"zh-CN",perPage:10,distractionFreeMode:!0,pagerDirection:"last",createIssueManually:!1,updateCountCallback:commentCount});function commentCount(e){try{document.getElementsByClassName("gitalk-comment-count")[0].innerHTML=e}catch(e){return!1}}gitalk.render("gitalk-container")</script></div></article><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar"><div class="left-col"><img src="/img/wechat-qcode.png"></div><div class="rght-col"><h2>关注公众号</h2><small><div>→「技术干货」每日推送</div><div>→「免费资料」随时领取</div><div>→「每月赠书」抽奖活动</div></small></div></div><div class="wechat-img"><a href="/img/wdewm.jpg" target="_blank">点击添加为微信,加入讨论技术群</a></div><div class="social-desc">除公众号以外，我还会在以下平台发布内容：</div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zhangzwd" target="_blank" title="Github" rel="external nofollow noopener noreferrer"><img src="/img/github.svg"></a><a class="social-icon" href="https://gitee.com/zhangzwd" target="_blank" title="Gitee" rel="external nofollow noopener noreferrer"><img src="/img/gitee.svg"></a><a class="social-icon" href="https://www.zhihu.com/people/zhangzhengwei/activities" target="_blank" title="知乎" rel="external nofollow noopener noreferrer"><img src="/img/zhihu.svg"></a><a class="social-icon" href="https://blog.csdn.net/zhang199091" target="_blank" title="CSDN" rel="external nofollow noopener noreferrer"><img src="/img/CSDN.svg"></a><a class="social-icon" href="https://www.jianshu.com/u/44dfb2efe2f6" target="_blank" title="简书" rel="external nofollow noopener noreferrer"><img src="/img/JianShu.svg"></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fa fa-bullhorn card-announcement-animation" aria-hidden="true"></i><span>公告</span></div><div class="announcement_content">感谢访问本站，如喜欢清收藏 ^_^<div class="card-info-bookmark is-center"><a class="bookmark button--primary button--animated" id="bookmark-it" href="javascript:;" title="加入书签" target="_self"><i class="fa fa-bookmark" aria-hidden="true"></i><span>加入书签</span></a></div></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fa fa-history" aria-hidden="true"></i><span>最新文章</span></div><div class="aside-recent-item"><div class="aside-recent-post"><a href="/mybatis3-finish/" target="_blank"><div class="aside-post-title"><div class="aside-post_title" href="/mybatis3-finish/" target="_blank" title="Mybatis3源码分析之总结">Mybatis3源码分析之总结</div><time class="aside-post_meta post-meta__date" title="发表于 2021-05-11 16:30:47">2021-05-11</time></div></a></div><div class="aside-recent-post"><a href="/mybatis3-mapper-dynamic-proxy/" target="_blank"><div class="aside-post-title"><div class="aside-post_title" href="/mybatis3-mapper-dynamic-proxy/" target="_blank" title="Mybatis3源码分析之Mapper动态代理">Mybatis3源码分析之Mapper动态代理</div><time class="aside-post_meta post-meta__date" title="发表于 2021-05-11 16:10:47">2021-05-11</time></div></a></div><div class="aside-recent-post"><a href="/mybatis3-mapper-implementation/" target="_blank"><div class="aside-post-title"><div class="aside-post_title" href="/mybatis3-mapper-implementation/" target="_blank" title="Mybatis3源码分析之Mapper实现">Mybatis3源码分析之Mapper实现</div><time class="aside-post_meta post-meta__date" title="发表于 2021-05-11 16:00:47">2021-05-11</time></div></a></div><div class="aside-recent-post"><a href="/mybatis3-mapper-generation/" target="_blank"><div class="aside-post-title"><div class="aside-post_title" href="/mybatis3-mapper-generation/" target="_blank" title="Mybatis3源码分析之Mapper生成过程">Mybatis3源码分析之Mapper生成过程</div><time class="aside-post_meta post-meta__date" title="发表于 2021-05-11 15:55:47">2021-05-11</time></div></a></div><div class="aside-recent-post"><a href="/mybatis3-plug/" target="_blank"><div class="aside-post-title"><div class="aside-post_title" href="/mybatis3-plug/" target="_blank" title="Mybatis3源码分析之插件解析">Mybatis3源码分析之插件解析</div><time class="aside-post_meta post-meta__date" title="发表于 2021-05-11 15:50:47">2021-05-11</time></div></a></div></div></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Java技术天地</div><div class="icp"><a href="http://www.beian.miit.gov.cn" target="_blank" rel="external nofollow noopener noreferrer"><img class="icp-icon" src="/img/icp.png"><span>鄂ICP备19013195号</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments"></i></a><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="external nofollow noopener noreferrer" style="color:#49b1f5">hexo-generator-search</a> <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async></script><script src="https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js"></script><script>document.addEventListener("DOMContentLoaded",function(){pangu.spacingElementById("content-inner")})</script><script src="/js/search/local-search.js"></script></body></html>